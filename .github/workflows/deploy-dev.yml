name: Deploy To Dev Environment

on:
  push:
    branches:
      - develop
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: tpt-server-dev
  S3_BUCKET: tpt-dev-deployments
  CODEDEPLOY_APP: tpt-server-dev
  DEPLOYMENT_GROUP: Develop

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Github Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: JDK 17ë²„ì „ ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: 17

      - name: Gradle ê¶Œí•œ ì„¤ì •
        run: chmod +x ./gradlew

      - name: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œí•˜ê¸°
        run: ./gradlew clean bootJar

      - name: AWS Resourceì— ì ‘ê·¼í•  ìˆ˜ ìžˆê²Œ AWS credentials ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: ECRì— ë¡œê·¸ì¸í•˜ê¸°
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker ì´ë¯¸ì§€ ìƒì„± ë° íƒœê·¸
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -t $ECR_REPOSITORY .
          
          # íƒœê·¸ ì„¤ì •
          docker tag $ECR_REPOSITORY $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REPOSITORY $ECR_REGISTRY/$ECR_REPOSITORY:latest
          
          echo "ECR_REGISTRY=$ECR_REGISTRY" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: ECRì— Docker ì´ë¯¸ì§€ Pushí•˜ê¸°
        run: |
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

      - name: ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
        run: |
          # í™˜ê²½ ì •ë³´ íŒŒì¼ ìƒì„±
          cat > deployment-info.env << EOF
          ECR_REGISTRY=${{ env.ECR_REGISTRY }}
          ECR_REPOSITORY=${{ env.ECR_REPOSITORY }}
          IMAGE_TAG=${{ env.IMAGE_TAG }}
          AWS_REGION=${{ env.AWS_REGION }}
          EOF
          
          # ë°°í¬ íŒ¨í‚¤ì§€ ì••ì¶•
          tar -czvf $GITHUB_SHA.tar.gz appspec.yml scripts deployment-info.env

      - name: S3ì— ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œí•˜ê¸°
        run: |
          aws s3 cp --region ${{ env.AWS_REGION }} ./$GITHUB_SHA.tar.gz s3://${{ env.S3_BUCKET }}/$GITHUB_SHA.tar.gz
          echo "âœ… ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ ì™„ë£Œ: s3://${{ env.S3_BUCKET }}/$GITHUB_SHA.tar.gz"

      - name: CodeDeployë¥¼ í†µí•œ ë°°í¬ ì‹¤í–‰
        run: |
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name ${{ env.CODEDEPLOY_APP }} \
            --deployment-config-name CodeDeployDefault.AllAtOnce \
            --deployment-group-name ${{ env.DEPLOYMENT_GROUP }} \
            --s3-location bucket=${{ env.S3_BUCKET }},bundleType=tgz,key=$GITHUB_SHA.tar.gz \
            --query 'deploymentId' \
            --output text)

          echo "ðŸš€ ë°°í¬ ì‹œìž‘: $DEPLOYMENT_ID"

          # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
          aws deploy wait deployment-successful --deployment-id $DEPLOYMENT_ID
          echo "âœ… ë°°í¬ ì™„ë£Œ!"