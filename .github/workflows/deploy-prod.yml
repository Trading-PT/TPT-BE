name: Deploy To Production Environment

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'           # v1.0.0 í˜•ì‹
      - 'v[0-9]+.[0-9]+.[0-9]+-hotfix*'   # v1.0.0-hotfix.1 í˜•ì‹
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to deploy (e.g., v1.2.3)'
        required: false

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: tpt-server-prod
  S3_BUCKET: tpt-prod-deployments
  CODEDEPLOY_APP: tpt-server-prod
  DEPLOYMENT_GROUP: Production-BlueGreen  # Blue/Green ë°°í¬ ê·¸ë£¹ìœ¼ë¡œ ë³€ê²½

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Github Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: JDK 17ë²„ì „ ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: 17

      - name: Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Gradle ê¶Œí•œ ì„¤ì •
        run: chmod +x ./gradlew

      - name: ë¹Œë“œí•˜ê¸°
        run: ./gradlew clean bootJar -x test

      - name: AWS Resourceì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ AWS credentials ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: ECRì— ë¡œê·¸ì¸í•˜ê¸°
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker ì´ë¯¸ì§€ ìƒì„± ë° íƒœê·¸
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -t $ECR_REPOSITORY .

          # íƒœê·¸ ì„¤ì •
          docker tag $ECR_REPOSITORY $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REPOSITORY $ECR_REGISTRY/$ECR_REPOSITORY:latest

          echo "ECR_REGISTRY=$ECR_REGISTRY" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: ECRì— Docker ì´ë¯¸ì§€ Pushí•˜ê¸°
        run: |
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

      - name: ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
        run: |
          # í™˜ê²½ ì •ë³´ íŒŒì¼ ìƒì„± (prod í™˜ê²½)
          cat > deployment-info.env << EOF
          ECR_REGISTRY=${{ env.ECR_REGISTRY }}
          ECR_REPOSITORY=${{ env.ECR_REPOSITORY }}
          IMAGE_TAG=${{ env.IMAGE_TAG }}
          AWS_REGION=${{ env.AWS_REGION }}
          SPRING_PROFILES_ACTIVE=prod
          EOF

          # ë°°í¬ íŒ¨í‚¤ì§€ ì••ì¶•
          tar -czvf $GITHUB_SHA.tar.gz appspec.yml scripts deployment-info.env

      - name: S3ì— ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œí•˜ê¸°
        run: |
          aws s3 cp --region ${{ env.AWS_REGION }} ./$GITHUB_SHA.tar.gz s3://${{ env.S3_BUCKET }}/$GITHUB_SHA.tar.gz
          echo "âœ… ë°°í¬ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ ì™„ë£Œ: s3://${{ env.S3_BUCKET }}/$GITHUB_SHA.tar.gz"

      - name: CodeDeploy Blue/Green ë°°í¬ ì‹¤í–‰
        run: |
          echo "ğŸ”µğŸŸ¢ Blue/Green ë°°í¬ ì‹œì‘..."

          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name ${{ env.CODEDEPLOY_APP }} \
            --deployment-config-name CodeDeployDefault.AllAtOnce \
            --deployment-group-name ${{ env.DEPLOYMENT_GROUP }} \
            --s3-location bucket=${{ env.S3_BUCKET }},bundleType=tgz,key=$GITHUB_SHA.tar.gz \
            --auto-rollback-configuration enabled=true,events=DEPLOYMENT_FAILURE,DEPLOYMENT_STOP_ON_REQUEST \
            --description "Blue/Green deployment for ${{ github.ref_name }} - ${{ github.sha }}" \
            --query 'deploymentId' \
            --output text)

          echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV
          echo "ğŸš€ Blue/Green ë°°í¬ ì‹œì‘: $DEPLOYMENT_ID"
          echo "ğŸ“Œ ë°°í¬ ë²„ì „: ${{ github.ref_name }}"
          echo "ğŸ“¦ ì»¤ë°‹: ${{ github.sha }}"

      - name: ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
        run: |
          echo "â³ Blue/Green ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          echo "   - Green í™˜ê²½ ìƒì„± ë° ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬"
          echo "   - Health Check í†µê³¼ ëŒ€ê¸°"
          echo "   - íŠ¸ë˜í”½ ì „í™˜"

          # Blue/Green ë°°í¬ëŠ” ì‹œê°„ì´ ë” ê±¸ë¦´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ëŒ€ê¸° ì‹œê°„ ì¦ê°€ (ìµœëŒ€ 40ë¶„)
          AWS_MAX_ATTEMPTS=80 aws deploy wait deployment-successful \
            --deployment-id ${{ env.DEPLOYMENT_ID }} \
            --region ${{ env.AWS_REGION }}

          echo "âœ… Blue/Green ë°°í¬ ì™„ë£Œ!"
          echo "ğŸ“Š ë°°í¬ ìƒíƒœ í™•ì¸: https://ap-northeast-2.console.aws.amazon.com/codesuite/codedeploy/deployments/${{ env.DEPLOYMENT_ID }}"

      - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "========================================="
          echo "ğŸ“‹ ë°°í¬ ê²°ê³¼ ìš”ì•½"
          echo "========================================="
          echo "ì• í”Œë¦¬ì¼€ì´ì…˜: ${{ env.CODEDEPLOY_APP }}"
          echo "ë°°í¬ ê·¸ë£¹: ${{ env.DEPLOYMENT_GROUP }}"
          echo "ë°°í¬ ID: ${{ env.DEPLOYMENT_ID }}"
          echo "ì´ë¯¸ì§€ íƒœê·¸: ${{ env.IMAGE_TAG }}"
          echo "========================================="

          # ë°°í¬ ìƒíƒœ í™•ì¸
          aws deploy get-deployment \
            --deployment-id ${{ env.DEPLOYMENT_ID }} \
            --region ${{ env.AWS_REGION }} \
            --query 'deploymentInfo.[status, deploymentOverview]' \
            --output table || true
